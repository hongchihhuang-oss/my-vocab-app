<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>單字庫 (Boot v17)</title>
    
    <!-- 1. 載入 CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 基礎樣式 */
        body { font-family: -apple-system, sans-serif; background: #f3f4f6; padding-bottom: env(safe-area-inset-bottom); height: 100vh; overflow: hidden; user-select: none; -webkit-user-select: none; }
        input, textarea { user-select: text; -webkit-user-select: text; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* 載入遮罩 (純 CSS/HTML，保證顯示) */
        #boot-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 錯誤訊息框 */
        #global-error { display: none; padding: 20px; text-align: center; color: #dc2626; position: absolute; bottom: 50px; width: 100%; }
    </style>

    <!-- 2. 全域錯誤攔截 (最優先執行) -->
    <script>
        window.onerror = function(msg, url, line) {
            var loader = document.getElementById('boot-loader');
            var errBox = document.getElementById('global-error');
            if(loader) loader.innerHTML = '<h2 style="color:red;font-weight:bold;font-size:20px;">⚠️ 啟動失敗</h2><p style="color:#666;margin-top:10px;">請截圖此畫面：</p><div style="text-align:left;background:#eee;padding:10px;margin:20px;border-radius:5px;font-family:monospace;font-size:12px;">'+msg+'<br>Line: '+line+'</div><button onclick="localStorage.clear();location.reload()" style="background:#dc2626;color:white;padding:10px 20px;border:none;border-radius:5px;font-weight:bold;">強制重置資料</button>';
            return false;
        };
    </script>
</head>
<body>
    <!-- 靜態載入畫面 -->
    <div id="boot-loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#666; font-size:14px;">正在啟動 v17...</p>
        <div id="global-error"></div>
    </div>

    <div id="root" class="h-full flex flex-col"></div>

    <!-- 3. 載入 React (使用最穩定的 CDN) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <script type="text/babel" data-presets="react">
        // 移除載入畫面
        setTimeout(() => {
            const el = document.getElementById('boot-loader');
            if(el) { el.style.opacity = '0'; setTimeout(()=>el.style.display='none', 500); }
        }, 600);

        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. 最單純的圖示組件 (避免物件錯誤) ---
        const IconBook = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>;
        const IconPlus = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>;
        const IconBrain = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>;
        const IconSettings = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const IconVolume = () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>;
        const IconEdit = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const IconSave = () => <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>;
        const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const IconLeft = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>;
        const IconRight = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>;
        const IconGlobe = () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const IconMode = () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>;

        // --- 2. 主程式 ---
        function App() {
            const [view, setView] = useState('list');
            const [words, setWords] = useState([]);
            const [settings, setSettings] = useState({ autoSpeak: true });

            // 初始化 (v17 全新開始)
            useEffect(() => {
                const d = localStorage.getItem('v17_words');
                if(d) {
                    try { setWords(JSON.parse(d)); } catch(e) {}
                }
                const s = localStorage.getItem('v17_set');
                if(s) {
                    try { setSettings(JSON.parse(s)); } catch(e) {}
                }
            }, []);

            // 存檔
            useEffect(() => localStorage.setItem('v17_words', JSON.stringify(words)), [words]);
            useEffect(() => localStorage.setItem('v17_set', JSON.stringify(settings)), [settings]);

            const addWord = (w) => setWords(p => [{...w, id: Date.now().toString(), mastery:0, createdAt:Date.now(), lastWrongAt:0}, ...p]);
            const delWord = (id) => { if(confirm("刪除？")) setWords(p => p.filter(w=>w.id!==id)); };
            const editWord = (id, d) => setWords(p => p.map(w => w.id===id ? {...w, ...d} : w));
            const updMastery = (id, l, wrong) => setWords(p => p.map(w => w.id===id ? {...w, mastery:Math.max(0,l), lastWrongAt: wrong?Date.now():w.lastWrongAt} : w));

            const speak = (w, ex, ph) => {
                window.speechSynthesis.cancel();
                const q = [{t:w,r:1}, {t:ex,r:0.85}, {t:ph,r:0.85}].filter(x=>x.t);
                let i=0;
                const play = () => {
                    if(i>=q.length) return;
                    const u = new SpeechSynthesisUtterance(q[i].t);
                    u.lang='en-US'; u.rate=q[i].r;
                    u.onend = () => { i++; if(i<q.length) setTimeout(play, 400); };
                    window.speechSynthesis.speak(u);
                };
                play();
            };

            const sorted = useMemo(() => [...words].sort((a,b) => (b.lastWrongAt||0)-(a.lastWrongAt||0) || (b.createdAt||0)-(a.createdAt||0)), [words]);

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <div className="bg-indigo-600 text-white p-4 shadow-md z-10 pt-safe flex justify-between items-center shrink-0">
                        <h1 className="font-bold flex gap-2 items-center"><IconBook/> 單字庫</h1>
                        <span className="text-xs bg-indigo-500 px-2 py-1 rounded">{words.length}</span>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-24">
                        {view==='list' && <WordList words={sorted} onDel={delWord} onEdit={editWord} onSpeak={speak} />}
                        {view==='add' && <AddWord onAdd={addWord} onCancel={()=>setView('list')} set={settings} onSpeak={speak} />}
                        {view==='quiz' && <Quiz words={words} onUpd={updMastery} onExit={()=>setView('list')} onSpeak={speak} />}
                        {view==='set' && <Settings words={words} setWords={setWords} set={settings} setSet={setSettings} />}
                    </div>

                    <div className="bg-white border-t flex justify-around p-2 pb-safe z-20 shadow-lg fixed bottom-0 w-full">
                        <NavBtn active={view==='list'} onClick={()=>setView('list')} icon={<IconBook/>} label="列表" />
                        <NavBtn active={view==='add'} onClick={()=>setView('add')} icon={<IconPlus/>} label="新增" />
                        <NavBtn active={view==='quiz'} onClick={()=>setView('quiz')} icon={<IconBrain/>} label="測驗" />
                        <NavBtn active={view==='set'} onClick={()=>setView('set')} icon={<IconSettings/>} label="設定" />
                    </div>
                </div>
            );
        }

        // --- Nav Button ---
        function NavBtn({active, onClick, icon, label}) {
            return <button onClick={onClick} className={`flex flex-col items-center w-16 p-1 ${active?'text-indigo-600':'text-gray-400'}`}>{icon}<span className="text-[10px]">{label}</span></button>;
        }

        // --- 1. Word List ---
        function WordList({ words, onDel, onEdit, onSpeak }) {
            const [idx, setIdx] = useState(0);
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({});

            const max = words.length-1;
            const cur = Math.min(Math.max(0, idx), max);
            useEffect(() => { if(idx>max) setIdx(max); setIsEditing(false); }, [words.length]);

            if(!words.length) return <div className="text-center mt-20 text-gray-400">請按「新增」來加入單字</div>;
            const w = words[cur];
            if(!w) return null;
            const isNew = (Date.now() - (w.createdAt || 0)) < 600000;

            const save = () => { onEdit(w.id, editData); setIsEditing(false); };
            const start = () => { setEditData({...w}); setIsEditing(true); };
            const change = (f,v) => setEditData(p => ({...p, [f]:v}));

            return (
                <div className="h-full flex flex-col justify-center items-center relative">
                    {!isEditing && <button onClick={()=>setIdx(i=>Math.max(0,i-1))} disabled={cur===0} className={`absolute left-0 p-3 bg-white rounded-full shadow z-10 ${cur===0?'opacity-30':''}`}><IconLeft/></button>}
                    
                    <div className="w-full bg-white rounded-3xl shadow-lg border p-6 text-center relative word-card flex flex-col items-center min-h-[450px]">
                        <div className="w-full flex justify-between mb-4">
                            <div className="flex gap-1">
                                {w.lastWrongAt>0 && <span className="text-xs font-bold text-red-500 bg-red-100 px-2 py-1 rounded">需複習</span>}
                                {isNew && !w.lastWrongAt && <span className="text-xs font-bold text-indigo-500 bg-indigo-100 px-2 py-1 rounded">NEW</span>}
                            </div>
                            <button onClick={isEditing?save:start} className="text-gray-400">
                                {isEditing ? <IconSave /> : <IconEdit />}
                            </button>
                        </div>

                        {isEditing ? (
                            <div className="w-full text-left space-y-2 text-sm overflow-y-auto h-80">
                                <input className="w-full border p-2 rounded font-bold" value={editData.word} onChange={e=>change('word',e.target.value)} />
                                <input className="w-full border p-2 rounded" value={editData.meaning} onChange={e=>change('meaning',e.target.value)} placeholder="中文" />
                                <div className="flex gap-2">
                                    <input className="w-1/2 border p-2 rounded" value={editData.pos} onChange={e=>change('pos',e.target.value)} placeholder="詞性" />
                                    <input className="w-1/2 border p-2 rounded" value={editData.phonetic} onChange={e=>change('phonetic',e.target.value)} placeholder="音標" />
                                </div>
                                <textarea className="w-full border p-2 rounded" rows="2" value={editData.englishDef} onChange={e=>change('englishDef',e.target.value)} placeholder="英解" />
                                <textarea className="w-full border p-2 rounded" rows="2" value={editData.example} onChange={e=>change('example',e.target.value)} placeholder="例句" />
                                <input className="w-full border p-2 rounded" value={editData.phrases} onChange={e=>change('phrases',e.target.value)} placeholder="片語" />
                            </div>
                        ) : (
                            <>
                                <h2 className="text-5xl font-extrabold text-gray-800 mb-2 break-all">{w.word}</h2>
                                <div className="text-gray-500 font-mono text-xl mb-6 flex justify-center gap-2">
                                    {w.pos && <span className="bg-gray-100 text-sm px-1 rounded self-center">{w.pos}</span>} {w.phonetic}
                                </div>
                                <button onClick={()=>onSpeak(w.word, w.example, w.phrases)} className="mb-6 p-4 bg-indigo-50 text-indigo-600 rounded-full active:scale-95 btn-press"><IconVolume/></button>
                                <div className="w-full text-left border-t pt-4 space-y-3">
                                    <h3 className="text-3xl font-bold text-indigo-900 text-center">{w.meaning||"(無中文)"}</h3>
                                    {w.englishDef && <p className="text-lg text-gray-500 italic text-center">"{w.englishDef}"</p>}
                                    {w.example && <div className="bg-gray-50 p-2 rounded text-xl italic text-gray-700 border-l-4 border-indigo-200">"{w.example}"</div>}
                                    {w.phrases && <div className="bg-orange-50 p-2 rounded text-lg text-gray-600 border-l-4 border-orange-200 font-bold">{w.phrases}</div>}
                                </div>
                                <button onClick={()=>onDel(w.id)} className="absolute bottom-4 right-4 text-gray-300 p-2"><IconTrash/></button>
                            </>
                        )}
                    </div>
                    {!isEditing && <button onClick={()=>setIdx(i=>Math.min(max,i+1))} disabled={cur===max} className={`absolute right-0 p-3 bg-white rounded-full shadow z-10 ${cur===max?'opacity-30':''}`}><IconRight/></button>}
                    <div className="text-center text-xs text-gray-400 mt-4">{cur+1} / {words.length}</div>
                </div>
            );
        }

        // --- 2. AddWord (API Search Only) ---
        function AddWord({ onAdd, onCancel, set, onSpeak }) {
            const [f, setF] = useState({ word:'', meaning:'', pos:'', phonetic:'', englishDef:'', example:'', phrases:'' });
            const [load, setLoad] = useState(false);

            const search = async () => {
                if(!f.word) return;
                setLoad(true);
                try {
                    window.speechSynthesis.resume(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(' '));
                    const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${f.word}`);
                    if(r.ok) {
                        const d = await r.json();
                        const e = d[0];
                        const def = e.meanings[0].definitions[0];
                        const ph = e.meanings.flatMap(m=>m.synonyms).slice(0,5).join(', ');
                        setF(p => ({
                            ...p, word: f.word,
                            phonetic: e.phonetic||'', pos: e.meanings[0].partOfSpeech||'',
                            englishDef: def.definition||'', example: def.example||'', phrases: ph||''
                        }));
                        if(set.autoSpeak) onSpeak(f.word, def.example, ph);
                    }
                } catch(e) { alert("查無資料，請手動輸入"); }
                setLoad(false);
            };

            const trans = () => f.word && window.open(`https://translate.google.com/?sl=en&tl=zh-TW&text=${encodeURIComponent(f.word)}`, '_blank');
            
            const submit = (e) => {
                e.preventDefault();
                if(!f.word) return alert("請輸入單字");
                onAdd(f); setF({ word:'', meaning:'', pos:'', phonetic:'', englishDef:'', example:'', phrases:'' }); alert("新增成功");
            };

            return (
                <div className="bg-white p-5 rounded-xl shadow-sm">
                    <h2 className="font-bold text-lg mb-4">新增單字</h2>
                    <div className="flex gap-2 mb-4">
                        <input className="flex-1 border-2 border-indigo-100 rounded px-3 py-2" placeholder="英文..." value={f.word} onChange={e=>setF({...f, word:e.target.value})} />
                        <button onClick={search} disabled={load} className="bg-indigo-600 text-white px-4 rounded font-bold disabled:opacity-50">{load?"...":"搜"}</button>
                    </div>
                    <form onSubmit={submit} className="space-y-3">
                        <div className="relative">
                            <label className="text-xs font-bold text-gray-500 absolute -top-2 left-2 bg-white px-1">中文</label>
                            <input className="w-full border p-2 rounded" value={f.meaning} onChange={e=>setF({...f, meaning:e.target.value})} />
                            <button type="button" onClick={trans} className="absolute right-2 top-2 text-xs text-blue-500 font-bold border px-1 rounded flex gap-1 items-center"><IconGlobe/> 翻譯</button>
                        </div>
                        <div className="flex gap-2">
                            <input className="w-1/2 border p-2 rounded" placeholder="詞性" value={f.pos} onChange={e=>setF({...f, pos:e.target.value})} />
                            <input className="w-1/2 border p-2 rounded" placeholder="音標" value={f.phonetic} onChange={e=>setF({...f, phonetic:e.target.value})} />
                        </div>
                        <textarea className="w-full border p-2 rounded text-sm" placeholder="英解" rows="2" value={f.englishDef} onChange={e=>setF({...f, englishDef:e.target.value})} />
                        <textarea className="w-full border p-2 rounded text-sm" placeholder="例句" rows="2" value={f.example} onChange={e=>setF({...f, example:e.target.value})} />
                        <input className="w-full border p-2 rounded text-sm" placeholder="片語" value={f.phrases} onChange={e=>setF({...f, phrases:e.target.value})} />
                        <div className="flex gap-2 pt-2">
                            <button type="button" onClick={onCancel} className="flex-1 py-2 bg-gray-100 rounded">取消</button>
                            <button className="flex-1 py-2 bg-indigo-600 text-white rounded font-bold">儲存</button>
                        </div>
                    </form>
                </div>
            );
        }

        // --- 3. Quiz ---
        function Quiz({ words, onUpd, onExit, onSpeak }) {
            const [q, setQ] = useState([]);
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [done, setDone] = useState(false);
            const [mode, setMode] = useState('zh');
            const [inp, setInp] = useState('');
            const [st, setSt] = useState('idle');
            const [hint, setHint] = useState(0);
            const [fail, setFail] = useState(false);
            const iRef = useRef(null);

            useEffect(() => {
                if(q.length || !words.length) return;
                const l = words.filter(w=>(w.mastery||0)<5);
                const h = words.filter(w=>(w.mastery||0)>=5);
                const all = [...l.sort(()=>0.5-Math.random()), ...h.sort(()=>0.5-Math.random())];
                const uniq = []; const s = new Set();
                for(const w of all) { if(uniq.length>=10) break; const t=w.word.toLowerCase(); if(!s.has(t)){ s.add(t); uniq.push(w); }}
                setQ(uniq);
            }, [words, q.length]);

            const cur = q[idx];
            const check = (e) => {
                e.preventDefault();
                if(!cur) return;
                if(st === 'wrong') { setSt('idle'); setInp(''); setTimeout(()=>iRef.current?.focus(), 10); return; }
                if(inp.trim().toLowerCase() === cur.word.toLowerCase()) {
                    setSt('correct'); onSpeak(cur.word); onUpd(cur.id, (cur.mastery||0)+1, false);
                    if(!fail && hint===0) setScore(s=>s+1);
                    setTimeout(() => {
                        if(idx+1 >= q.length) setDone(true);
                        else { setIdx(i=>i+1); setInp(''); setSt('idle'); setHint(0); setFail(false); }
                    }, 1000);
                } else { setSt('wrong'); setFail(true); onUpd(cur.id, Math.max(0, (cur.mastery||0)-1), true); }
            };

            if(!words.length) return <div className="text-center p-10 text-gray-400">無單字</div>;
            if(!q.length) return <div className="text-center p-10">準備中...</div>;
            if(done) return <div className="p-6 text-center"><h2 className="text-2xl font-bold mb-4">完成！</h2><div className="text-5xl font-bold text-indigo-600 mb-6">{score}/{q.length}</div><button onClick={()=>{setQ([]);setIdx(0);setScore(0);setDone(false)}} className="w-full py-3 bg-indigo-600 text-white rounded mb-2">重測</button><button onClick={onExit} className="w-full py-3 bg-gray-100 rounded">列表</button></div>;

            const disp = (mode === 'en' && cur.englishDef) ? cur.englishDef : (cur.meaning||'(無中文)');

            return (
                <div className="p-4 fade-in">
                    <div className="flex justify-between mb-4 text-sm text-gray-400 font-bold"><button onClick={onExit}>離開</button><span>Q {idx+1}/{q.length}</span></div>
                    <div className="bg-white rounded-2xl shadow-lg p-6 text-center relative">
                        <button onClick={()=>setMode(m=>m==='zh'?'en':'zh')} className="absolute top-3 right-3 text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 flex items-center gap-1"><IconMode/> {mode==='zh'?'中文':'英解'}</button>
                        <div className="text-sm text-gray-400 mt-2">請拼出英文</div>
                        <div className="text-3xl font-bold text-indigo-900 my-6">{disp}</div>
                        <div className="h-8 mb-2">{hint>0 && <span className="text-orange-500 font-mono text-lg tracking-widest bg-orange-50 px-2 rounded">{cur.word.substring(0, hint)}...</span>}</div>
                        <form onSubmit={check}>
                            <input ref={iRef} type="text" autoFocus className={`w-full text-center text-2xl p-2 border-b-2 outline-none ${st==='wrong'?'border-red-500 text-red-600':'border-indigo-200'}`} value={inp} onChange={e=>{setInp(e.target.value); if(st==='wrong') setSt('idle');}} disabled={st==='correct'} autoComplete="off" autoCorrect="off" />
                            {st === 'idle' && <div className="flex gap-2 mt-6"><button type="button" onClick={()=>{setHint(h=>h+1); setFail(true);}} className="flex-1 py-2 bg-orange-100 text-orange-600 rounded">提示</button><button className="flex-[2] py-2 bg-indigo-600 text-white rounded shadow-lg">送出</button></div>}
                        </form>
                        {st==='correct' && <div className="mt-6 text-green-600 font-bold animate-bounce">Correct!</div>}
                        {st==='wrong' && <div className="mt-6 text-red-500 font-bold cursor-pointer" onClick={()=>{setSt('idle'); setInp('');}}>錯誤，點此重試</div>}
                    </div>
                </div>
            );
        }

        // --- 4. Settings ---
        function Settings({ words, setWords, set, setSet }) {
            const fRef = useRef(null);
            
            const exp = async () => {
                if(!words.length) return alert("無資料");
                const blob = new Blob([JSON.stringify(words, null, 2)], {type:"application/json"});
                const file = new File([blob], `backup.json`, {type:"application/json"});
                if(navigator.canShare && navigator.canShare({files:[file]})) {
                    try { await navigator.share({files:[file], title:'備份'}); return; } catch(e){}
                }
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup.json`; a.click();
            };
            const imp = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    try {
                        const d = JSON.parse(evt.target.result);
                        if(confirm(`匯入 ${d.length} 筆？`)) {
                            const news = d.map(w => ({...w, id: Date.now()+Math.random(), mastery:0, createdAt:Date.now(), lastWrongAt:0 }));
                            setWords(p => [...news, ...p]); alert("成功");
                        }
                    } catch(err) { alert("檔案錯誤"); }
                };
                r.readAsText(f); e.target.value='';
            };

            return (
                <div className="p-5 space-y-6 fade-in">
                    <div className="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center"><span className="font-bold text-gray-700">自動發音</span><input type="checkbox" className="w-5 h-5" checked={set.autoSpeak} onChange={e=>setSet({...set, autoSpeak:e.target.checked})} /></div>
                    <div className="space-y-3">
                        <button onClick={exp} className="w-full p-4 bg-white border rounded-xl flex gap-3 font-bold items-center text-blue-600"><IconDownload/> 匯出備份 (iOS Share)</button>
                        <button onClick={()=>fRef.current.click()} className="w-full p-4 bg-white border rounded-xl flex gap-3 font-bold items-center text-green-600"><IconUpload/> 匯入備份</button>
                        <input type="file" ref={fRef} onChange={imp} className="hidden" accept=".json" />
                        <button onClick={()=>{if(confirm("清空？")) setWords([])}} className="w-full p-4 bg-red-50 text-red-500 border border-red-100 rounded-xl flex gap-3 font-bold justify-center items-center"><IconTrash/> 清空資料</button>
                    </div>
                </div>
            );
        }

        // 獨立圖示組件 (確保不會有 React.createElement 錯誤)
        const IconBook = () => <Svg d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>;
        const IconPlus = () => <Svg d="M12 4v16m8-8H4"/>;
        const IconBrain = () => <Svg d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>;
        const IconSettings = () => <Svg d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z"/>;
        const IconVolume = () => <Svg d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>;
        const IconTrash = () => <Svg d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>;
        const IconLeft = () => <Svg d="M15 19l-7-7 7-7"/>;
        const IconRight = () => <Svg d="M9 5l7 7-7 7"/>;
        const IconEdit = () => <Svg d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>;
        const IconSave = () => <Svg d="M5 13l4 4L19 7"/>;
        const IconGlobe = () => <Svg d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>;
        const IconDownload = () => <Svg d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>;
        const IconUpload = () => <Svg d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>;
        const IconMode = () => <Svg d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>;

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


